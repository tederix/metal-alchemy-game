<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Металлургическая алхимия</title>
<style>
body{margin:0;font-family:Arial;display:flex;flex-direction:column;align-items:center;padding:12px;gap:12px;transition:background 0.3s,color 0.3s;overflow-x:hidden;}
body.dark{background:#151515;color:#eee;}
body.light{background:#f5f5f5;color:#222;}
h2{margin:0 0 8px 0;font-size:16px;}
main{width:100%;max-width:1400px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.panel{padding:12px;border-radius:10px;transition:background 0.3s;}
body.dark .panel{background:#222;}
body.light .panel{background:#fff;}
#inventory,#mobile-inventory{display:flex;gap:8px;flex-wrap:wrap;transition:all 0.3s ease;}
.item,.btn{padding:8px 10px;border-radius:8px;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;}
body.dark .item,.btn{background:#3a3a3a;color:#eee;}
body.light .item,.btn{background:#ddd;color:#222;}
.item{cursor:grab;width:64px;text-align:center;display:flex;flex-direction:column;align-items:center;transition:all 0.3s ease;}
.item img{width:64px;height:64px;}
.item span{margin-top:4px;font-size:12px;}
.machine{border-radius:10px;padding:10px;min-width:220px;flex:1;display:flex;flex-direction:column;align-items:center;transition:all 0.3s ease;}
body.dark .machine{background:#292929;color:#eee;}
body.light .machine{background:#eee;color:#222;}
.machine-title{text-align:center;font-weight:bold;margin-bottom:6px;}
.slots{min-height:64px;padding:6px;border-radius:8px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;position:relative;transition:all 0.3s ease;}
body.dark .slots{background:#1f1f1f;}
body.light .slots{background:#ddd;}
.slot-item{padding:0;border-radius:6px;width:64px;text-align:center;display:flex;flex-direction:column;align-items:center;transition:all 0.3s ease;opacity:0;transform:translateY(-10px);}
.slot-item.show{opacity:1;transform:translateY(0);}
body.dark .slot-item{background:#444;color:#eee;}
body.light .slot-item{background:#bbb;color:#222;}
.slot-item img{width:64px;height:64px;}
.slot-item span{margin-top:4px;font-size:12px;}
.machine.dragover{outline:3px dashed rgba(136,170,255,0.18);}
.flash{position:absolute;width:100%;height:100%;background:yellow;opacity:0.7;border-radius:50%;animation:flashAnim 0.5s ease;}
@keyframes flashAnim{0%{transform:scale(0);opacity:0.7;}50%{transform:scale(1.5);opacity:0.5;}100%{transform:scale(0);opacity:0;}}
.confetti-piece{position:absolute;width:8px;height:8px;background:gold;animation:confettiFall 2s linear forwards;}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);}100%{transform:translateY(400px) rotate(720deg);opacity:0;}}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:10;}
body.dark .modal{background:rgba(0,0,0,0.85);}
body.light .modal{background:rgba(255,255,255,0.85);}
.modal-content{background:#222;padding:20px;border-radius:12px;text-align:center;transition:all 0.3s ease;color:#eee;}
body.light .modal-content{background:#fff;color:#222;}
.modal-content button{margin-top:12px;padding:12px 16px;border-radius:8px;border:none;background:#3a3a3a;color:#eee;cursor:pointer;transition:all 0.3s ease;font-size:14px;}
body.light .modal-content button{background:#ddd;color:#222;}
#toggle-inv{position:fixed;top:10px;left:10px;z-index:1000;display:none;}
#mobile-inventory{position:fixed;top:0;left:0;right:0;background:rgba(0,0,0,0.9);color:#fff;padding:10px;display:none;flex-wrap:wrap;gap:8px;z-index:999;justify-content:center;transition:all 0.3s ease;}
.controls{display:flex;gap:6px;margin-top:6px;}
.controls .btn{flex:1;}
#recipes-panel{position:fixed;top:50px;right:10px;width:250px;background:rgba(0,0,0,0.9);color:#fff;padding:10px;border-radius:10px;display:none;flex-direction:column;gap:6px;max-height:80vh;overflow:auto;z-index:1000;transition:all 0.3s ease;}
#recipes-panel.show{display:flex;}
#recipes-panel h3{text-align:center;margin:0 0 6px 0;}
@media (max-width:768px){
  main{grid-template-columns:1fr;}
  .machine{min-width:100%;}
  #inventory{display:none;}
  #toggle-inv{display:block;}
  #mobile-inventory .item img{width:48px;height:48px;}
  #mobile-inventory .item span{font-size:10px;}
}
@media (min-width:769px){
  #toggle-inv{display:none;}
  #inventory{display:flex;}
  #mobile-inventory{display:none;}
}
</style>
</head>
<body class="dark">

<div style="width:100%;display:flex;justify-content:flex-end;padding:6px;gap:6px;">
  <button class="btn" onclick="toggleTheme()">Сменить тему</button>
  <button class="btn" onclick="toggleRecipes()">Рецепты</button>
</div>

<button id="toggle-inv" class="btn">Инвентарь</button>
<div id="mobile-inventory"></div>
<div id="recipes-panel"><h3>Открытые рецепты</h3><div id="recipes-list"></div></div>

<div id="modal" class="modal">
  <div class="modal-content">
    <h2>Инструкция</h2>
    <p>Перетащи компоненты в агрегаты, чтобы создавать новые материалы. Добейся создания трубы!</p>
    <button onclick="startGame()">Начать</button>
  </div>
</div>

<main style="display:none;">
<section class="panel">
<h2>Инвентарь</h2>
<div id="inventory"></div>
</section>

<section class="panel" style="grid-column:1 / -1;">
<h2>Установки</h2>
<div id="machines-container" style="display:flex;flex-wrap:wrap;gap:12px;"></div>
</section>
</main>

<script>
// === Инициализация ===
const BASE_ITEMS=["воздух","уголь","руда"];
const MACHINES=["коксовая батарея","установка сухого тушения кокса","воздухоразделительная установка","валковый магнитный сепаратор","агломерационная машина","гранулятор","доменная печь","конвертер","машина непрерывного литья заготовок","стан горячей прокатки","стан холодной прокатки","трубогибочный стан"];
const RECIPES=[
{components:["уголь"],machine:"коксовая батарея",result:"раскаленный кокс"},
{components:["раскаленный кокс"],machine:"установка сухого тушения кокса",result:"кокс"},
{components:["руда"],machine:"валковый магнитный сепаратор",result:"концентрат"},
{components:["концентрат"],machine:"агломерационная машина",result:"агломерат"},
{components:["концентрат"],machine:"гранулятор",result:"окатыши"},
{components:["кокс","агломерат"],machine:"доменная печь",result:"чугун"},
{components:["кокс","окатыши"],machine:"доменная печь",result:"чугун"},
{components:["кокс","агломерат","окатыши"],machine:"доменная печь",result:"чугун"},
{components:["воздух"],machine:"воздухоразделительная установка",result:"кислород"},
{components:["чугун","кислород"],machine:"конвертер",result:"сталь"},
{components:["сталь"],machine:"машина непрерывного литья заготовок",result:"слябы"},
{components:["слябы"],machine:"стан горячей прокатки",result:"горячекатаный лист"},
{components:["горячекатаный лист"],machine:"стан холодной прокатки",result:"холоднокатаный лист"},
{components:["холоднокатаный лист"],machine:"трубогибочный стан",result:"труба"}];
const IMAGE_MAP={
"воздух":"icons/vozduh.png","уголь":"icons/ugol.png","руда":"icons/ruda.png",
"раскаленный кокс":"icons/raskalennyi_koks.png","кокс":"icons/koks.png",
"концентрат":"icons/koncentrat.png","агломерат":"icons/agglomerat.png",
"окатыши":"icons/okatyshi.png","чугун":"icons/chugun.png",
"кислород":"icons/kislorod.png","сталь":"icons/stal.png",
"слябы":"icons/slyaby.png","горячекатаный лист":"icons/goryachekatany_list.png",
"холоднокатаный лист":"icons/kholodnokatany_list.png","труба":"icons/truba.png"};

let state={inventory:[],machines:{},discovered:{}};
MACHINES.forEach(m=>state.machines[m]=[]);

// === Основные функции ===
function toggleTheme(){document.body.classList.toggle("dark");document.body.classList.toggle("light");}
function toggleRecipes(){document.getElementById("recipes-panel").classList.toggle("show");}
function startGame(){state.inventory=[...BASE_ITEMS]; document.getElementById("modal").style.display="none"; document.querySelector("main").style.display="grid"; render();}

// === Инвентарь ===
function createItemElement(name,index){
  const el=document.createElement("div"); el.className="item"; el.draggable=true; el.dataset.index=index; el.dataset.base=BASE_ITEMS.includes(name)?"1":"";
  const img=document.createElement("img"); img.src=IMAGE_MAP[name]; img.alt=name;
  const span=document.createElement("span"); span.textContent=name;
  el.appendChild(img); el.appendChild(span);
  setTimeout(()=>el.classList.add("show"),50);
  el.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/index",index); e.dataTransfer.setData("text/base",el.dataset.base?name:"");});
  let dragged=null;
  el.addEventListener("touchstart",e=>{dragged=el;el.classList.add("dragging"); e.preventDefault();});
  el.addEventListener("touchmove",e=>{if(!dragged)return; const t=e.touches[0]; dragged.style.position="absolute"; dragged.style.left=t.pageX-32+"px"; dragged.style.top=t.pageY-32+"px"; dragged.style.zIndex=1000;});
  el.addEventListener("touchend",e=>{
    if(!dragged)return; dragged.style.position=""; dragged.style.left=""; dragged.style.top=""; dragged.style.zIndex="";
    document.querySelectorAll(".machine").forEach(machine=>{
      const r=machine.getBoundingClientRect(); const t=e.changedTouches[0];
      if(t.clientX>=r.left && t.clientX<=r.right && t.clientY>=r.top && t.clientY<=r.bottom){
        dropToMachine(name,index,machine.dataset.machine);
      }
    });
    dragged.classList.remove("dragging"); dragged=null;
  });
  return el;
}

function dropToMachine(name,index,machine){
  const slots=document.getElementById("slots-"+machine);
  state.machines[machine].push(name);
  if(!BASE_ITEMS.includes(name)) state.inventory.splice(index,1);
  const el=document.createElement("div"); el.className="slot-item show";
  const img=document.createElement("img"); img.src=IMAGE_MAP[name]; img.alt=name;
  const span=document.createElement("span"); span.textContent=name;
  el.appendChild(img); el.appendChild(span); slots.appendChild(el);
  renderInventory(); renderMobileInventory();
}

function renderInventory(){const inv=document.getElementById("inventory"); inv.innerHTML=""; state.inventory.forEach((it,idx)=>inv.appendChild(createItemElement(it,idx)));}
function renderMobileInventory(){const inv=document.getElementById("mobile-inventory"); inv.innerHTML=""; state.inventory.forEach((it,idx)=>inv.appendChild(createItemElement(it,idx)));}

// === Машины и процесс ===
function renderMachines(){
  const container=document.getElementById("machines-container"); container.innerHTML="";
  MACHINES.forEach(m=>{
    const div=document.createElement("div"); div.className="machine"; div.dataset.machine=m;
    div.innerHTML=`<div class="machine-title">${m}</div><div class="slots" id="slots-${m}"></div>
    <div class="controls">
      <div class="btn" onclick="processMachine('${m}')">Обработать</div>
      <div class="btn" onclick="clearMachine('${m}')">Очистить</div>
    </div>`;
    container.appendChild(div);
  });
  for(const m of MACHINES){
    const slots=document.getElementById("slots-"+m); slots.innerHTML="";
    state.machines[m].forEach(it=>{
      const el=document.createElement("div"); el.className="slot-item show";
      const img=document.createElement("img"); img.src=IMAGE_MAP[it]; img.alt=it;
      const span=document.createElement("span"); span.textContent=it;
      el.appendChild(img); el.appendChild(span); slots.appendChild(el);
    });
  }
  setupDropZones();
}

function setupDropZones(){
  document.querySelectorAll(".machine").forEach(me=>{
    me.ondragover=ev=>{ev.preventDefault(); me.classList.add("dragover");};
    me.ondragleave=()=>me.classList.remove("dragover");
    me.ondrop=ev=>{
      ev.preventDefault(); me.classList.remove("dragover");
      const base=ev.dataTransfer.getData("text/base"); const idx=ev.dataTransfer.getData("text/index");
      const slots=document.getElementById("slots-"+me.dataset.machine);
      if(base){state.machines[me.dataset.machine].push(base);
        const el=document.createElement("div"); el.className="slot-item show";
        const img=document.createElement("img"); img.src=IMAGE_MAP[base]; img.alt=base;
        const span=document.createElement("span"); span.textContent=base;
        el.appendChild(img); el.appendChild(span); slots.appendChild(el); return;}
      if(idx!=="" && state.inventory[idx]){
        const item=state.inventory[idx];
        if(!BASE_ITEMS.includes(item)) state.inventory.splice(idx,1);
        state.machines[me.dataset.machine].push(item);
        const el=document.createElement("div"); el.className="slot-item show";
        const img=document.createElement("img"); img.src=IMAGE_MAP[item]; img.alt=item;
        const span=document.createElement("span"); span.textContent=item;
        el.appendChild(img); el.appendChild(span); slots.appendChild(el); renderInventory(); renderMobileInventory();
      }
    };
  });
}

// === Крафт и анимации ===
function flashMachine(machine){const slots=document.getElementById("slots-"+machine); const flash=document.createElement("div"); flash.className="flash"; slots.appendChild(flash); setTimeout(()=>flash.remove(),500);}
function confetti(){for(let i=0;i<50;i++){const c=document.createElement("div"); c.className="confetti-piece"; c.style.left=Math.random()*window.innerWidth+"px"; document.body.appendChild(c); setTimeout(()=>c.remove(),2000);}}
function animateCraft(slots,result,machine,callback){flashMachine(machine); state.inventory.push(result); renderInventory(); renderMobileInventory(); setTimeout(callback,500);}

function processMachine(machine){
  const slotsElem=document.getElementById("slots-"+machine); const slots=state.machines[machine];
  if(slots.length===0){alert("Нет компонентов"); return;}
  let candidate=null;
  for(const r of RECIPES){
    if(r.machine!==machine) continue;
    if(slots.length!==r.components.length) continue;
    const need={}; r.components.forEach(c=>need[c]=(need[c]||0)+1);
    const have={}; slots.forEach(s=>have[s]=(have[s]||0)+1);
    let ok=true; for(const k in need){if(need[k]!==have[k]){ok=false; break;}} for(const k in have){if(need[k]!==have[k]){ok=false; break;}}
    if(ok){candidate=r; break;}
  }
  if(candidate){
    animateCraft(slotsElem,candidate.result,machine,()=>{
      state.machines[machine]=[]; 
      if(candidate.result==="труба"){confetti(); alert("Поздравляем! Вы создали трубу!");}
      const text=candidate.components.join(" + ")+" + "+candidate.machine+" → "+candidate.result;
      if(!state.discovered[text]) state.discovered[text]=true;
      renderMachines(); renderRecipes();
    });
  } else {state.machines[machine]=[]; renderMachines(); alert("Неудача. Компоненты потеряны.");}
}

function clearMachine(machine){state.machines[machine]=[]; renderMachines();}

function renderRecipes(){
  const rdiv=document.getElementById("recipes-list"); rdiv.innerHTML="";
  const keys=Object.keys(state.discovered);
  if(keys.length===0){rdiv.textContent="Пока рецептов нет";}
  else keys.forEach(k=>{const div=document.createElement("div"); div.textContent=k; rdiv.appendChild(div);});
}

function render(){renderInventory(); renderMobileInventory(); renderMachines(); renderRecipes();}

document.getElementById("toggle-inv").addEventListener("click",()=>{
  const inv=document.getElementById("mobile-inventory");
  inv.style.display=inv.style.display==="flex"?"none":"flex";
  renderMobileInventory();
});
</script>
</body>
</html>
